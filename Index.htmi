<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth, 
  createUserWithEmailAndPassword, 
  signInWithEmailAndPassword,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  updateDoc, 
  increment 
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© */
function generateRef() {
  return Math.random().toString(36).substring(2,8).toUpperCase();
}

/* ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ */
window.register = async () => {
  const email = email.value;
  const password = password.value;
  const refInput = document.getElementById("ref").value;

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid = cred.user.uid;
    const myRef = generateRef();

    await setDoc(doc(db, "users", uid), {
      email,
      balance: 0,
      refCode: myRef,
      teamCount: 0,
      level: 1,
      invitedBy: refInput || null
    });

    // Ù„Ùˆ Ø¬Ø§ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø¯Ø¹ÙˆØ©
    if (refInput) {
      const q = await getDoc(doc(db, "refs", refInput));
      if (q.exists()) {
        const inviterId = q.data().uid;
        await updateDoc(doc(db,"users",inviterId),{
          teamCount: increment(1),
          balance: increment(10)
        });
      }
    }

    await setDoc(doc(db,"refs",myRef),{ uid });

    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
  } catch(e){ alert(e.message); }
};

/* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
window.login = async () => {
  try {
    await signInWithEmailAndPassword(auth, email.value, password.value);
  } catch(e){ alert(e.message); }
};

/* Ø³Ø­Ø¨ Ø±Ø§ØªØ¨ ÙˆÙ‡Ù…ÙŠ */
window.withdraw = async () => {
  const user = auth.currentUser;
  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);

  if (snap.data().balance >= 50) {
    await updateDoc(ref,{ balance: increment(-50) });
    alert("ğŸ’° ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„ÙˆÙ‡Ù…ÙŠ");
  } else {
    alert("âŒ Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");
  }
};

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
onAuthStateChanged(auth, async user=>{
  if(user){
    authBox.style.display="none";
    appBox.style.display="block";

    const snap = await getDoc(doc(db,"users",user.uid));
    const d = snap.data();

    balance.innerText = d.balance;
    team.innerText = d.teamCount;
    level.innerText = Math.floor(d.teamCount/3)+1;
    link.innerText = location.origin+"?ref="+d.refCode;
  }
});
</script>

<style>
body{background:#0f2027;color:#fff;font-family:Arial;display:flex;justify-content:center;align-items:center;height:100vh}
.box{background:#1c1c1c;padding:20px;width:320px;border-radius:12px;text-align:center}
input,button{width:100%;padding:10px;margin:6px 0;border-radius:6px;border:none}
button{background:#00c853;color:#000;font-weight:bold}
</style>
</head>

<body>

<div class="box" id="authBox">
<h2>MaliApp</h2>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<input id="ref" placeholder="ÙƒÙˆØ¯ Ø¯Ø¹ÙˆØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
<button onclick="register()">ØªØ³Ø¬ÙŠÙ„</button>
<button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="box" id="appBox" style="display:none">
<h3>Ø±ØµÙŠØ¯Ùƒ: <span id="balance"></span> Ù…Ø§Ù„ÙŠ</h3>
<p>Ø§Ù„ÙØ±ÙŠÙ‚: <span id="team"></span></p>
<p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: <span id="level"></span></p>
<p>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</p>
<small id="link"></small>
<button onclick="withdraw()">Ø³Ø­Ø¨ Ø±Ø§ØªØ¨ (50)</button>
</div>

</body>
</html>
