<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>MaliApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  arrayUnion
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBfMUa-8vsUZ_1r5F79iSKOKqMre99lwbI",
  authDomain: "maliapp-63f91.firebaseapp.com",
  projectId: "maliapp-63f91",
  storageBucket: "maliapp-63f91.appspot.com",
  messagingSenderId: "901870433172",
  appId: "1:901870433172:web:325b2312af72099279d581"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ğŸ¯ ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ */
window.register = async () => {
  const email = emailInput.value;
  const pass = passwordInput.value;

  if(!email || !pass) return alert("Ø¹Ø¨ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„");

  try {
    const res = await createUserWithEmailAndPassword(auth,email,pass);
    const uid = res.user.uid;

    const inviteCode = uid.slice(0,6);

    await setDoc(doc(db,"users",uid),{
      email,
      balance: 0,
      inviteCode,
      team: [],
      level: 1
    });

    alert("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨");
  } catch(e) {
    alert(e.message);
  }
};

/* ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ */
window.login = async () => {
  try {
    await signInWithEmailAndPassword(auth,emailInput.value,passwordInput.value);
  } catch(e) {
    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„");
  }
};

/* ğŸ‘€ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø­Ø§Ù„Ø© */
onAuthStateChanged(auth, async user => {
  if(user){
    authBox.style.display="none";
    appBox.style.display="block";

    const snap = await getDoc(doc(db,"users",user.uid));
    const data = snap.data();

    balance.innerText = data.balance;
    inviteLink.innerText =
      location.origin + location.pathname + "?ref=" + data.inviteCode;

    renderTeam(data.team);
  }
});

/* ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ ÙØ±ÙŠÙ‚ */
window.addFriend = async () => {
  const user = auth.currentUser;
  const refEmail = friendEmail.value;

  if(!refEmail) return;

  const ref = doc(db,"users",user.uid);

  await updateDoc(ref,{
    balance: 10,
    team: arrayUnion(refEmail)
  });

  alert("ğŸ‘¤ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø¹Ø¶Ùˆ Ù„Ù„ÙØ±ÙŠÙ‚");
  location.reload();
};

/* ğŸ’¸ Ø³Ø­Ø¨ Ø±Ø§ØªØ¨ ÙˆÙ‡Ù…ÙŠ */
window.withdraw = async () => {
  const user = auth.currentUser;
  const ref = doc(db,"users",user.uid);
  const snap = await getDoc(ref);

  let bal = snap.data().balance;
  if(bal < 10) return alert("Ø§Ù„Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ");

  await updateDoc(ref,{ balance: bal - 10 });
  alert("ğŸ’° ØªÙ… Ø³Ø­Ø¨ Ø§Ù„Ø±Ø§ØªØ¨");
  location.reload();
};

/* Ø¹Ø±Ø¶ Ø§Ù„ÙØ±ÙŠÙ‚ */
function renderTeam(team){
  teamList.innerHTML="";
  team.forEach(t=>{
    const d=document.createElement("div");
    d.innerText="ğŸ‘¤ "+t;
    teamList.appendChild(d);
  });
}
</script>

<style>
body{
  background:linear-gradient(135deg,#6a11cb,#2575fc);
  font-family:Arial;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.box{
  background:#fff;
  width:330px;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
input,button{
  width:100%;
  padding:10px;
  margin:6px 0;
}
button{
  background:#2575fc;
  color:white;
  border:none;
  border-radius:6px;
}
</style>
</head>

<body>

<div class="box" id="authBox">
  <h2>MaliApp</h2>
  <input id="emailInput" type="email" placeholder="Email">
  <input id="passwordInput" type="password" placeholder="Password">
  <button onclick="register()">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨</button>
  <button onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</button>
</div>

<div class="box" id="appBox" style="display:none">
  <h3>Ø±ØµÙŠØ¯Ùƒ: <span id="balance">0</span></h3>
  <p>Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ©:</p>
  <small id="inviteLink"></small>

  <input id="friendEmail" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ ØµØ¯ÙŠÙ‚">
  <button onclick="addFriend()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„ÙØ±ÙŠÙ‚</button>

  <button onclick="withdraw()">Ø³Ø­Ø¨ Ø±Ø§ØªØ¨</button>

  <h4>ğŸ‘¥ Ø§Ù„ÙØ±ÙŠÙ‚</h4>
  <div id="teamList"></div>
</div>

</body>
</html>
